name: Build MySQL 5.7.33 ARM64 RPM

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      debug:
        description: '是否启用调试模式'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: centos7
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          dockerRunArgs: |
            --privileged
          setup: |
            yum update -y
            yum install -y \
              sudo \
              gcc \
              gcc-c++ \
              make \
              cmake \
              rpm-build \
              wget \
              curl \
              git \
              ncurses-devel \
              openssl-devel \
              libaio-devel \
              libtirpc-devel \
              tcp_wrappers-devel \
              readline-devel \
              zlib-devel \
              pam-devel \
              openldap-devel \
              cyrus-sasl-devel \
              libtirpc-devel \
              numactl-devel \
              jemalloc-devel \
              libevent-devel \
              libcurl-devel \
              libxml2-devel \
              libffi-devel \
              pcre-devel \
              libedit-devel \
              boost-devel \
              boost-system \
              boost-filesystem \
              boost-thread \
              boost-program-options \
              boost-iostreams \
              boost-regex \
              boost-date-time \
              boost-atomic \
              boost-chrono
          run: |
            # 创建工作目录
            mkdir -p /work/mysql
            cd /work/mysql
            
            # 下载 MySQL 5.7.33 源码
            wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.33.tar.gz
            
            # 验证下载文件的完整性
            echo "正在验证下载文件的完整性..."
            wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.33.tar.gz.md5
            md5sum -c mysql-5.7.33.tar.gz.md5
            
            # 解压源码
            tar xzf mysql-5.7.33.tar.gz
            cd mysql-5.7.33
            
            # 创建编译目录
            mkdir build
            cd build 

            # 配置 MySQL 编译选项
            cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=/usr \
              -DMYSQL_DATADIR=/var/lib/mysql \
              -DSYSCONFDIR=/etc \
              -DINSTALL_INFODIR=share/mysql/docs \
              -DINSTALL_MANDIR=share/man \
              -DINSTALL_PLUGINDIR=lib/mysql/plugin \
              -DINSTALL_SCRIPTDIR=bin \
              -DINSTALL_INCLUDEDIR=include/mysql \
              -DINSTALL_DOCREADMEDIR=share/mysql \
              -DINSTALL_SUPPORTFILESDIR=share/mysql \
              -DINSTALL_MYSQLSHAREDIR=share/mysql \
              -DINSTALL_DOCDIR=share/mysql/docs \
              -DINSTALL_SHAREDIR=share/mysql \
              -DINSTALL_MYSQLTESTDIR=share/mysql/mysql-test \
              -DINSTALL_SQLBENCHDIR=share/mysql/sql-bench \
              -DINSTALL_MYSQLDATADIR=share/mysql/data \
              -DINSTALL_UNIX_ADDRDIR=/var/run/mysqld/mysqld.sock \
              -DWITH_SSL=system \
              -DWITH_ZLIB=system \
              -DWITH_LIBWRAP=ON \
              -DWITH_JEMALLOC=ON \
              -DWITH_EXTRA_CHARSETS=all \
              -DENABLED_LOCAL_INFILE=1 \
              -DWITH_EMBEDDED_SERVER=1 \
              -DWITH_INNODB_MEMCACHED=1 \
              -DWITH_ARCHIVE_STORAGE_ENGINE=1 \
              -DWITH_BLACKHOLE_STORAGE_ENGINE=1 \
              -DWITH_FEDERATED_STORAGE_ENGINE=1 \
              -DWITH_PARTITION_STORAGE_ENGINE=1 \
              -DWITH_PERFSCHEMA_STORAGE_ENGINE=1 \
              -DWITH_BOOST=/usr \
              -DWITH_SYSTEMD=0 \
              -DWITH_UNIT_TESTS=0 \
              -DWITHOUT_ROCKSDB=1 \
              -DWITHOUT_MROONGA=1 \
              -DWITHOUT_TOKUDB=1 \
              -DWITHOUT_CONNECT=1 \
              -DWITHOUT_NDBCLUSTER=1 \
              -DWITHOUT_NDB=1 \
              -DWITHOUT_NDBINFO=1 \
              -DWITHOUT_NDB_DEBUG=1 \
              -DWITHOUT_NDB_DEBUG_OPTS=1

            # 编译 MySQL
            make -j$(nproc)
            
            # 安装 MySQL
            make install
            
            # 创建 RPM 打包目录结构
            mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
            
            # 准备 RPM spec 文件
            cat > ~/rpmbuild/SPECS/mysql.spec << 'EOF'
            %define _prefix /usr
            %define _sysconfdir /etc
            %define _localstatedir /var
            %define _datadir /var/lib/mysql
            
            Name: mysql
            Version: 5.7.33
            Release: 1%{?dist}
            Summary: MySQL Server
            License: GPLv2
            Group: Applications/Databases
            URL: https://www.mysql.com/
            Source0: mysql-5.7.33.tar.gz
            BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
            
            %description
            MySQL is a multi-user, multi-threaded SQL database server.
            
            %prep
            %setup -q
            
            %build
            mkdir -p build
            cd build
            cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=%{_prefix} \
              -DMYSQL_DATADIR=%{_datadir} \
              -DSYSCONFDIR=%{_sysconfdir} \
              -DWITH_SSL=system \
              -DWITH_ZLIB=system \
              -DWITH_LIBWRAP=ON \
              -DWITH_JEMALLOC=ON \
              -DWITH_EXTRA_CHARSETS=all \
              -DENABLED_LOCAL_INFILE=1 \
              -DWITH_EMBEDDED_SERVER=1 \
              -DWITH_INNODB_MEMCACHED=1 \
              -DWITH_ARCHIVE_STORAGE_ENGINE=1 \
              -DWITH_BLACKHOLE_STORAGE_ENGINE=1 \
              -DWITH_FEDERATED_STORAGE_ENGINE=1 \
              -DWITH_PARTITION_STORAGE_ENGINE=1 \
              -DWITH_PERFSCHEMA_STORAGE_ENGINE=1 \
              -DWITH_BOOST=/usr \
              -DWITH_SYSTEMD=0 \
              -DWITH_UNIT_TESTS=0
            make %{?_smp_mflags}
            
            %install
            rm -rf $RPM_BUILD_ROOT
            cd build
            make install DESTDIR=$RPM_BUILD_ROOT
            
            %clean
            rm -rf $RPM_BUILD_ROOT
            
            %files
            %defattr(-,root,root)
            %{_prefix}/bin/*
            %{_prefix}/lib/mysql/*
            %{_prefix}/include/mysql/*
            %{_prefix}/share/mysql/*
            %{_sysconfdir}/my.cnf
            %{_datadir}/
            
            %changelog
            * Wed Mar 20 2024 MySQL Builder <builder@example.com> - 5.7.33-1
            - Initial package for ARM64
            EOF
            
            # 复制源码到 RPM 构建目录
            cp mysql-5.7.33.tar.gz ~/rpmbuild/SOURCES/
            
            # 构建 RPM 包
            rpmbuild -bb ~/rpmbuild/SPECS/mysql.spec
            
            # 复制生成的 RPM 包到工作目录
            cp ~/rpmbuild/RPMS/aarch64/mysql-5.7.33-1.aarch64.rpm /work/
            
            # 列出生成的 RPM 包
            ls -la /work/
            
            # 将 RPM 包复制到共享目录以便上传
            mkdir -p /github/workspace/output
            cp /work/*.rpm /github/workspace/output/
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: mysql-5.7.33-arm64-rpm
          path: output/*.rpm
          retention-days: 30
            